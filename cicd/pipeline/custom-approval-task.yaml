apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: custom-approval
spec:
  params:
  - name: recipients
    type: string
    description: recipient email addresses
  - name: pipeline_name
    type: string
  - name: pipelinerun_name
    type: string  
  steps:
  - env:
      - name: HOME
        value: /tekton/home
    image: >-
      image-registry.openshift-image-registry.svc:5000/openshift/cli:latest
    name: oc
    resources: {}
    script: |
      #!/usr/bin/env bash
      # [[ "$(workspaces.manifest-dir.bound)" == "true" ]] && \
      # cd $(workspaces.manifest-dir.path)
      # [[ "$(workspaces.kubeconfig-dir.bound)" == "true" ]] && \
      # [[ -f $(workspaces.kubeconfig-dir.path)/kubeconfig ]] && \
      # export KUBECONFIG=$(workspaces.kubeconfig-dir.path)/kubeconfig
      # $(params.SCRIPT)
      oc expose pod/$(params.pipelinerun_name)-wait-for-approve-pod --port 5000
      oc expose service/$(params.pipelinerun_name)-wait-for-approve-pod
    securityContext:
      runAsNonRoot: true
      runAsUser: 65532
  - image: docker.io/paichayon1/tekton-approve:0.3
    name: wait-approve
    script: |
      # loop until approval=true
      echo $(params.recipients)
      echo $(params.pipeline_name)
      echo $(params.pipelinerun_name)
      # oc expose pod/test-approve-11sssq-wait-for-approve-pod --port 5000
      # oc expose service/test-approve-11sssq-wait-for-approve-pod
      # test-approve-11sssq-wait-for-approve-pod-cicd.apps.524vf.dynamic.opentlc.com

      code=$(shuf -i 1000000000000000-9999999999999999 -n 1)
      echo "code number: $code" 
      python approval.py "$code"



